<!DOCTYPE html>
<html>

<head>
    <title>Admin Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

</head>

<body>
    <h2>ğŸš¨ Admin Dashboard</h2>

    <p>Total Emergencies: <span id="total">0</span></p>
    <p>Pending: <span id="pending">0</span></p>
    <p>Accepted: <span id="accepted">0</span></p>
    <p>Rejected: <span id="rejected">0</span></p>

    <ul id="emergencyList"></ul>

    <h3>ğŸ—ºï¸ Live Map</h3>
    <div id="map" style="height: 400px; width:400px;"></div>
    



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


    <script>
        const map = L.map("map").setView([23.8103, 90.4125], 7); // Bangladesh
        const redIcon = L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
            shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });


        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "Â© OpenStreetMap",
        }).addTo(map);
        let emergencyMarkers = [];


        const socket = io("http://localhost:5000");

        const totalEl = document.getElementById("total");
        const pendingEl = document.getElementById("pending");
        const acceptedEl = document.getElementById("accepted");
        const rejectedEl = document.getElementById("rejected");
        const emergencyList = document.getElementById("emergencyList");

        function updateStats(emergencies) {
            const total = emergencies.length;
            const pending = emergencies.filter(e => e.status === "pending").length;
            const accepted = emergencies.filter(e => e.status === "accepted").length;
            const rejected = emergencies.filter(e => e.status === "rejected").length;

            totalEl.innerText = total;
            pendingEl.innerText = pending;
            acceptedEl.innerText = accepted;
            rejectedEl.innerText = rejected;


            emergencyList.innerHTML = "";
            emergencies.forEach(e => {
                const li = document.createElement("li");
                li.innerText = `${e.message} | Status: ${e.status}`;
                emergencyList.appendChild(li);
            });
        }

        async function loadEmergencies() {
            const res = await fetch("http://localhost:5000/api/emergency");
            const data = await res.json();
            updateStats(data.data);
            showEmergenciesOnMap(data.data);
        }
        function showEmergenciesOnMap(emergencies) {
            // remove old markers
            emergencyMarkers.forEach(m => map.removeLayer(m));
            emergencyMarkers = [];

            emergencies.forEach(e => {
                if (!e.location) return;

                const marker = L.marker([e.location.lat, e.location.lng], { icon: redIcon })
                    .addTo(map)
                    .bindPopup(`ğŸš¨ ${e.message}<br>Status: ${e.status}`);

                emergencyMarkers.push(marker);
            });
        }
        //Export CSV file
      /*  document.getElementById("exportBtn").addEventListener("click", async () => {
            // 1ï¸âƒ£ Fetch emergencies from backend
            const res = await fetch("http://localhost:5000/api/emergency");
            const data = await res.json();

            // 2ï¸âƒ£ Convert to CSV format
            let csv = "Message,Latitude,Longitude,Date,Status\n";

            data.forEach(e => {
                csv += `"${e.message}",${e.location.lat},${e.location.lng},${new Date(e.createdAt).toLocaleString()},${e.status || "pending"}\n`;
            });

            // 3ï¸âƒ£ Create downloadable file
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "emergency_report.csv";
            a.click();

            // 4ï¸âƒ£ Clean up
            URL.revokeObjectURL(url);
        });*/



        loadEmergencies();

        // Real-time updates
        socket.on("Emergency", (emergency) => {
            loadEmergencies();
        });

        socket.on("EmergencyAccepted", (emergency) => {
            loadEmergencies();
        });
    </script>
</body>

</html>